<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/5/24
 * Time: 9:57
 */

namespace app\admin\logic;

use app\common\model\U9Pr as prModel;

class RequireOrder extends BaseLogic{
    protected $table = 'atw_u9_pr';

    /*
     * 得到请购单信息
     */
    function getPrList($start, $length, $where, $isNeedAppointSup = 0){
        $where = empty($where) ? [] : $where;

        $sqlBuilder = prModel::alias('a')
            ->field('a.*,b.desc,b.pur_attr')
            ->join('item b', 'a.item_code=b.code', 'LEFT')
            ->where($where)
            ->limit("$start,$length")
            ->order('a.update_at desc');

        if($isNeedAppointSup == 1){
            // 需要手动指定供应商的 有： status=hang 挂起的、status='flow' &&  inquiry_way in[assign,exclusive,compete]
            $sqlBuilder->where("a.status='hang' OR (status='flow' AND a.inquiry_way IN ('assign','exclusive','compete'))");
        }
       // if(!key_exists('status', $where)){
       //     $sqlBuilder->where('a.status', 'in', ['hang', 'inquiry', 'quoted', 'flow', 'wait']);
       // }
        $list = $sqlBuilder->select();

        //        echo $this->getLastSql();
        if($list){
            $list = collection($list)->toArray();
        }
        //dump($list);
        return $list;
    }

    /*
     *无分页得到所有信息
     */
    function getAllListInfo($where){
        if(!empty($where)){
            if(key_exists('status', $where)){
                $list = prModel::alias('a')
                    ->field('a.*,b.desc,b.pur_attr')
                    ->join('item b', 'a.item_code=b.code', 'LEFT')
                    ->where($where)
                    ->select();
            }else{
                //->where('a.status','<>','close')
                $list = prModel::alias('a')
                    ->field('a.*,b.desc,b.pur_attr')
                    ->join('item b', 'a.item_code=b.code', 'LEFT')
                    ->where($where)
                    ->select();
            }

        }else{
            //->where('a.status','<>','close')
            $list = prModel::alias('a')
                ->field('a.*,b.desc,b.pur_attr')
                ->join('item b', 'a.item_code=b.code', 'LEFT')
                ->select();
        }

        if($list){
            $list = collection($list)->toArray();
        }
        return $list;
    }

    /*
     * 得到列表数量
     */
    function getListNum($where = [],$isNeedAppointSup = 0){

        $sqlBuilder = prModel::alias('a')
            ->field('a.*,b.desc,b.pur_attr')
            ->join('item b', 'a.item_code=b.code', 'LEFT')
            ->where($where)
            ->order('a.update_at desc');

        if($isNeedAppointSup == 1){
            // 需要手动指定供应商的 有： status=hang 挂起的、status='flow' &&  inquiry_way in[assign,exclusive,compete]
            $sqlBuilder->where("a.status='hang' OR (status='flow' AND a.inquiry_way IN ('assign','exclusive','compete'))");
        }
        return $sqlBuilder->count();
    }

    /*
     *根据itemcode得到供应商物料交叉表信息
     */
    function getSupList($item_code){
        $list = model('U9SupItem')
            ->alias('a')
            ->field('a.*,b.status')
            ->join('supplier_info b', 'a.sup_code=b.code', 'LEFT')
            ->where('item_code', $item_code)
            ->select();
        if($list){
            $list = collection($list)->toArray();
        }
        //dump($list);
        return $list;
    }

    /*
     * 保存唯一指定供应商到表
     */
    function updateByPrCode($where, $data){
        return model('U9Pr')->where($where)->update($data);
    }

    /*
     * 获得pro_no项目号
     */
    function getProNo($where){
        return model('U9Pr')->where($where)->value('pro_no');
    }

    /*
     * 得到请购日期
     */
    function getPrDate($where){
        return model('U9Pr')->where($where)->value('pr_date');
    }

    /*
    * 得到请购日期
    */
    function getPrStatus($where){
        return model('U9Pr')->where($where)->value('status');
    }

    /*
     * 通过条件得到请购单数量
     */
    function getNumByWhere($where){
        return prModel::where($where)->count();
    }

    /*
     * 得到通过pr_id得到一条pr记录
     */
    function getPrInfo($where){
        return prModel::where($where)->find();
    }

    /*
     * 改变pr_status
     */
    function updatePr($where, $data){
        return PrModel::where($where)->update($data);
    }

    /**
     * 待询价请购单 = 待询价+挂起的
     */
    function getUnQuoteNum(){
        return $this->where('status', 'IN', ['init', 'hang'])->count();
    }

    /**
     * 统计流标的请购单
     */
    function countFlow(){
        $count = $this->where('status', 'flow')->count();
        return $count;
    }

    /**
     * 统计流标的询价单
     */
    function countFlowIo(){
        $count = model('Io', 'logic')
            ->alias('a')
            ->field('a.id')
            ->join('item b', 'a.item_code=b.code', 'LEFT')
            ->join('u9_pr pr', 'pr.id = a.pr_id', 'LEFT')
            ->where('pr.status', 'flow')
            ->group('pr_id')
            ->count();
        return $count;
    }
}